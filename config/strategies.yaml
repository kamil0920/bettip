# Betting Strategies Configuration
# Base config from sniper-all-results-17 (2026-01-27)
# R32/R33 analysis (2026-01-30): BTTS disabled (negative holdout ROI both runs)
# R33 holdout: 8/9 markets profitable, weighted avg ROI +39.0%, Pearson r=0.862 vs R32
# Search spaces expanded in config_manager.py for R34 based on boundary analysis

# Global settings
settings:
  min_odds: 1.30
  max_odds: 10.0
  min_confidence: 0.8  # Minimum P(profit) to deploy
  bankroll_fraction: 0.02  # Kelly fraction for bet sizing

# Calibration settings (updated from sniper-all-results-17, 2026-01-27)
# All markets use Platt scaling calibration from walk-forward validation
calibration:
  enabled: true
  method: "platt"
  per_market:
    OVER_2.5:
      factor: 0.5
      enabled: true  # ENABLED: +122.6% ROI, 89% precision, CV=0.15
      min_threshold: 0.85
    HOME_WIN:
      factor: 0.7
      enabled: true  # ENABLED: +119.7% ROI, 88% precision, CV=0.12
      min_threshold: 0.80
    BTTS:
      factor: 0.90
      enabled: false  # DISABLED: negative holdout ROI in R32 (-7.4%) and R33 (-11.5%)
      min_threshold: 0.75
    FOULS:
      factor: 1.0
      enabled: true  # +105.8% ROI, 82% precision, CV=0.28
      min_threshold: 0.75
    SHOTS:
      factor: 1.0
      enabled: true  # BEST: +131.2% ROI, 92% precision, CV=0.04
      min_threshold: 0.80
    CORNERS:
      factor: 0.88
      enabled: false  # DISABLED: needs validation (only worked in R17)
      min_threshold: 0.65
    AWAY_WIN:
      factor: 1.0
      enabled: true  # +108.3% ROI, 83% precision, CV=0.14
      min_threshold: 0.68
    UNDER_2.5:
      factor: 1.0
      enabled: true  # +117.3% ROI, 87% precision, CV=0.07
      min_threshold: 0.75
    CARDS:
      factor: 1.0
      enabled: false  # DISABLED: unstable between runs
      min_threshold: 0.75

# Model training settings
training:
  test_size: 0.2
  val_size: 0.2
  n_optuna_trials: 100
  random_state: 42
  cv_folds: 5

# Bet type strategies
strategies:
  # Rank 1: Asian Handicap - DISABLED
  # optimization-results-15: -12.5% ROI, 45.5% precision, P(profit) = 18.3%
  # 55 bets, Sharpe = -0.129 - clearly unprofitable
  asian_handicap:
    enabled: false
    approach: "regression"
    model_type: "ensemble"
    target: "goal_margin"

    line_filter:
      min: -4.0
      max: -1.5
    bet_side: "away"
    edge_threshold: 0.3

    expected_roi: -12.5  # Updated from optimization-results-15
    p_profit: 0.18

    # Features to use (top from permutation importance)
    top_features:
      - margin_edge
      - composite_expected_margin
      - season_margin_per_game
      - away_win_prob_elo
      - poisson_away_win_prob
      - home_away_gd_diff
      - home_scoring_streak
      - away_pts_to_leader
      - h2h_away_wins
      - home_goals_conceded_ema

    # Odds columns
    odds_column: "avg_ah_away"

  # Rank 2: BTTS (Both Teams To Score)
  # sniper-all-results-17: +132.3% ROI, 83.6% precision, CV=0.34
  # R32: -7.4% holdout ROI, R33: -11.5% holdout ROI — negative in both runs
  btts:
    enabled: false  # DISABLED: negative holdout ROI in both R32 and R33
    approach: "classification"
    model_type: "xgboost"  # Changed from catboost per R17 optimization
    target: "btts"  # Both teams score

    probability_threshold: 0.75  # Strict threshold for quality over volume
    calibration_factor: 0.7
    bet_side: "yes"
    min_odds: 2.0  # Optimal from R17
    max_odds: 3.5  # Optimal from R17

    expected_roi: 132.3  # Updated from sniper-all-results-17
    p_profit: 0.84

    top_features:
      - home_scores_prob
      - away_scores_prob
      - btts_composite
      - league_btts_rate
      - home_attack_strength
      - away_attack_strength
      - home_clean_sheet_rate
      - away_clean_sheet_rate
      - total_attack
      - min_defense

    odds_column: "btts_yes_odds"

  # Rank 3: Away Win - PRODUCTION READY
  # sniper-all-results-17: +108.3% ROI, 83.3% precision, CV=0.14
  # 60 bets - consistent across both R16 and R17 runs
  away_win:
    enabled: true
    approach: "classification"
    model_type: "lightgbm"
    target: "away_win"

    probability_threshold: 0.68  # Optimized from R17 (was 0.70)
    calibration_method: "platt"
    min_odds: 1.5  # Optimal from R17
    max_odds: 3.5  # Optimal from R17

    # LightGBM hyperparameters from Phase 4 Optuna tuning
    model_params:
      n_estimators: 200
      max_depth: 3
      learning_rate: 0.0193
      num_leaves: 91
      min_child_samples: 71
      reg_alpha: 0.00009
      reg_lambda: 0.00002

    expected_roi: 108.3  # Updated from sniper-all-results-17
    expected_precision: 0.833  # 83.3% precision
    p_profit: 0.999

    # Use 271 RFE-optimized features (loaded from rfe_20260124_112415.json)
    use_rfe_features: true
    rfe_features_file: "experiments/outputs/feature_selection/rfe_20260124_112415.json"

    # Top 10 features by SHAP importance (for reference)
    top_features:
      - poisson_away_win_prob
      - away_win_prob_elo
      - odds_away_prob
      - away_attack_strength
      - ppg_diff
      - home_goals_conceded_ema
      - position_diff
      - home_form_ema
      - away_form_ema
      - home_away_gd_diff

    odds_column: "avg_away_open"

  # Rank 4: Under 2.5 Goals - EXCELLENT PERFORMER
  # sniper-all-results-17: +117.3% ROI, 86.9% precision, CV=0.07 (excellent)
  # 926 bets - massive improvement from R16
  under25:
    enabled: true
    approach: "classification"
    model_type: "lightgbm"  # Changed from logistic_regression per R17
    target: "under25"

    probability_threshold: 0.75  # Raised from 0.55 per R17 optimization
    calibration_method: "platt"
    min_odds: 1.5  # Optimal from R17
    max_odds: 3.5  # Optimal from R17

    expected_roi: 117.3  # Updated from sniper-all-results-17
    p_profit: 0.87

    odds_column: "avg_under25"

  # Rank 5: Over 2.5 Goals - EXCELLENT PERFORMER
  # sniper-all-results-17: +122.6% ROI, 89.0% precision, CV=0.15 (excellent)
  # 219 bets - strong improvement from R16
  over25:
    enabled: true  # Re-enabled per R17 optimization
    approach: "classification"
    model_type: "lightgbm"
    target: "over25"

    probability_threshold: 0.85  # Strictest threshold for high precision
    calibration_factor: 0.5
    min_odds: 1.5  # Optimal from R17
    max_odds: 3.5  # Optimal from R17

    expected_roi: 122.6  # Updated from sniper-all-results-17
    p_profit: 0.89

    odds_column: "avg_over25"

  # Rank 6: Home Win - EXCELLENT PERFORMER
  # sniper-all-results-17: +119.7% ROI, 87.9% precision, CV=0.12 (excellent)
  # 289 bets - 5x volume increase with better ROI
  home_win:
    enabled: true  # Re-enabled per R17 optimization
    approach: "classification"
    model_type: "stacking"  # Changed from xgboost per R17
    target: "home_win"

    probability_threshold: 0.80  # Raised from 0.55 per R17 optimization
    min_odds: 1.5  # Optimal from R17
    max_odds: 3.5  # Optimal from R17

    expected_roi: 119.7  # Updated from sniper-all-results-17
    p_profit: 0.88

    odds_column: "avg_home_open"

  # ==========================================================================
  # NICHE MARKETS (High ROI from walk-forward validation)
  # ==========================================================================

  # Corners betting - DISABLED
  # optimization-results-15: -3.0% ROI, 57.5% precision, P(profit) = 36%
  # 120 bets, Sharpe = -0.036 - no edge despite decent precision
  corners:
    enabled: false  # Negative ROI from walk-forward validation
    approach: "classification"
    model_type: "stacking_xgb"
    target: "total_corners"

    lines:
      - line: 10.5
        direction: "UNDER"
        threshold: 0.70
        expected_roi: -3.0  # Updated
      - line: 9.5
        direction: "OVER"
        threshold: 0.65
        expected_roi: -3.0
      - line: 11.5
        direction: "UNDER"
        threshold: 0.75
        expected_roi: -3.0

    key_features:
      - ref_corner_avg
      - ref_corner_std
      - odds_goals_expectation
      - home_elo
      - away_elo

  # Cards betting (Over 4.5) - RECOVERING
  # R16: +108.8% ROI, R17: 0 bets, R32: -100% (1 bet), R33: +14.8% (45 bets, 55.6% precision)
  # Marginal edge, low volume — monitor in R34
  cards:
    enabled: false  # Still disabled: marginal R33 results, needs R34 confirmation
    approach: "classification"
    model_type: "xgboost"
    target: "total_cards"

    lines:
      - line: 4.5
        direction: "OVER"
        threshold: 0.70
        expected_roi: 8.6  # Updated from optimization-results-15

    key_features:
      - expected_home_cards
      - home_cards_ema
      - away_cards_ema
      - expected_total_cards
      - ref_draw_pct
      - away_fouls_drawn_ema
      - expected_total_fouls
      - away_avg_yellows

  # Shots betting (Over 24.5) - BEST OVERALL PERFORMER
  # sniper-all-results-17: +131.2% ROI, 92.5% precision, CV=0.04 (best consistency)
  # 1305 bets - massive volume with exceptional stability
  shots:
    enabled: true
    approach: "classification"
    model_type: "stacking"  # Changed from ensemble_average per R17
    target: "total_shots"

    lines:
      - line: 24.5
        direction: "OVER"
        threshold: 0.80  # Raised from 0.70 per R17 optimization
        expected_roi: 131.2  # Updated from sniper-all-results-17
        min_odds: 1.5  # Optimal from R17
        max_odds: 3.5  # Optimal from R17

    calibration_method: "platt"

    key_features:
      - expected_total_shots
      - expected_total_corners
      - combined_shots_ema
      - home_corners_won_ema
      - away_shot_accuracy
      - expected_away_shots
      - home_shots_ema_x
      - away_shots_conceded_ema
      - ppg_diff
      - position_diff

  # Fouls betting (Over 24.5) - SOLID PERFORMER
  # sniper-all-results-17: +105.8% ROI, 82.3% precision, CV=0.28 (good)
  # 345 bets - consistent between R16 and R17
  fouls:
    enabled: true
    approach: "classification"
    model_type: "catboost"  # Changed from logistic_regression per R17
    target: "total_fouls"
    calibration_method: "platt"
    calibration_factor: 1.0

    lines:
      - line: 24.5
        direction: "OVER"
        threshold: 0.75  # Raised from 0.65 per R17 optimization
        expected_roi: 105.8  # Updated from sniper-all-results-17
        min_odds: 1.5  # Optimal from R17
        max_odds: 3.5  # Optimal from R17

    key_features:
      - expected_total_fouls
      - expected_home_fouls
      - expected_away_fouls
      - expected_total_cards
      - home_cards_ema
      - away_fouls_drawn_ema
      - home_fouls_drawn_ema
      - discipline_diff
      - h2h_avg_goals
      - poisson_draw_prob

# League-specific adjustments (optional)
league_adjustments:
  premier_league:
    btts_rate_adjustment: 0.02  # Slightly higher BTTS in EPL
  bundesliga:
    btts_rate_adjustment: 0.05  # Highest BTTS rate
  la_liga:
    btts_rate_adjustment: -0.03  # Lower BTTS rate

# Portfolio selection (daily diversified singles)
portfolio:
  max_daily_singles: 10
  max_per_match: 3
  max_per_market: 5
  min_leagues: 2

# Risk management
risk_management:
  max_daily_bets: 10
  max_stake_per_bet: 0.05  # 5% of bankroll
  stop_loss_daily: 0.10  # Stop if 10% down
  take_profit_daily: 0.20  # Lock in if 20% up

# Pilot mode settings
pilot:
  paper_trading: true  # No real money initially
  min_bets_before_live: 100  # Validate with 100 paper bets first
  performance_threshold: 0.05  # Need 5% ROI in paper trading
