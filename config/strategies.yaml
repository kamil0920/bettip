# Betting Strategies Configuration
# These are the optimized strategies from backtesting

# Global settings
settings:
  min_odds: 1.30
  max_odds: 10.0
  min_confidence: 0.8  # Minimum P(profit) to deploy
  bankroll_fraction: 0.02  # Kelly fraction for bet sizing

# Calibration settings (from weekend paper trading 2026-01-17)
# Models were found to be overconfident. Apply these corrections.
calibration:
  enabled: true
  method: "temperature"  # temperature, isotonic, platt, beta
  per_market:
    OVER_2.5:
      factor: 0.5  # Halve probabilities - very overconfident
      enabled: false  # DISABLE - 30% hit rate unacceptable
    HOME_WIN:
      factor: 0.7  # Reduce by 30%
      enabled: false  # Keep disabled per backtest
    BTTS:
      factor: 0.90  # Backtest showed -6.5% gap (67% pred -> 60.5% actual)
      min_threshold: 0.70
    FOULS:
      factor: 1.0  # Keep as-is - underconfident, has edge
      min_threshold: 0.70
    SHOTS:
      factor: 0.92  # Backtest: -5.6% gap (71% pred -> 65.3% actual)
      min_threshold: 0.70
    CORNERS:
      factor: 0.88  # Backtest: -8.2% gap (71% pred -> 63% actual)
      min_threshold: 0.70
    AWAY_WIN:
      factor: 0.97  # Backtest: -2.2% gap (69% pred -> 66.8% actual)
      min_threshold: 0.55

# Model training settings
training:
  test_size: 0.2
  val_size: 0.2
  n_optuna_trials: 100
  random_state: 42
  cv_folds: 5

# Bet type strategies
strategies:
  # Rank 1: Asian Handicap - Heavy Favorite Away (DISABLED - negative ROI)
  asian_handicap:
    enabled: false
    approach: "regression"  # regression or classification
    model_type: "ensemble"  # XGBoost, LightGBM, CatBoost ensemble
    target: "goal_margin"

    # Value betting parameters
    line_filter:
      min: -4.0
      max: -1.5  # Heavy favorites only
    bet_side: "away"
    edge_threshold: 0.3

    # Expected performance
    expected_roi: 20.8
    p_profit: 0.97

    # Features to use (top from permutation importance)
    top_features:
      - margin_edge
      - composite_expected_margin
      - season_margin_per_game
      - away_win_prob_elo
      - poisson_away_win_prob
      - home_away_gd_diff
      - home_scoring_streak
      - away_pts_to_leader
      - h2h_away_wins
      - home_goals_conceded_ema

    # Odds columns
    odds_column: "avg_ah_away"

  # Rank 2: BTTS (Both Teams To Score)
  # CALIBRATION NOTE: Weekend paper trading showed 43% hit rate vs 64% predicted
  # Increase threshold and apply 0.7 calibration factor
  btts:
    enabled: true
    approach: "classification"
    model_type: "catboost"
    target: "btts"  # Both teams score

    probability_threshold: 0.75  # Increased from 0.6 after calibration analysis
    calibration_factor: 0.7  # Reduce raw probability by 30%
    bet_side: "yes"

    expected_roi: 16.0
    p_profit: 0.98

    top_features:
      - home_scores_prob
      - away_scores_prob
      - btts_composite
      - league_btts_rate
      - home_attack_strength
      - away_attack_strength
      - home_clean_sheet_rate
      - away_clean_sheet_rate
      - total_attack
      - min_defense

    odds_column: "btts_yes_odds"  # Estimated if not available

  # Rank 3: Away Win
  away_win:
    enabled: true
    approach: "classification"
    model_type: "catboost"
    target: "away_win"

    probability_threshold: 0.45

    expected_roi: 14.5
    p_profit: 1.0

    top_features:
      - ah_line_close
      - home_avg_yellows
      - position_diff
      - away_season_ppg
      - rest_days_diff
      - home_defense_strength
      - away_season_gd
      - poisson_draw_prob
      - away_pts_to_cl
      - elo_diff

    odds_column: "avg_away_open"

  # Rank 4: Under 2.5 Goals
  under25:
    enabled: false  # Lower confidence (64%)
    approach: "classification"
    model_type: "logistic_regression"
    target: "under25"

    probability_threshold: 0.6

    expected_roi: 5.5
    p_profit: 0.64

    odds_column: "avg_under25"

  # Rank 5: Over 2.5 Goals
  # DISABLED: Weekend paper trading showed 30% hit rate vs 70% predicted
  # Expected goals model overestimates by +1.05 goals on average
  # DO NOT ENABLE until xG model is recalibrated
  over25:
    enabled: false  # CRITICAL: 30% hit rate - model severely broken
    approach: "classification"
    model_type: "lightgbm"
    target: "over25"

    probability_threshold: 0.85  # If re-enabled, use very high threshold
    calibration_factor: 0.5  # Halve all probabilities

    expected_roi: 4.6  # Historical - actual is negative
    p_profit: 0.75

    odds_column: "avg_over25"

  # Rank 6: Home Win - Not profitable
  home_win:
    enabled: false
    approach: "classification"
    model_type: "xgboost"
    target: "home_win"

    probability_threshold: 0.55

    expected_roi: -2.6
    p_profit: 0.20

    odds_column: "avg_home_open"

  # ==========================================================================
  # NICHE MARKETS (High ROI from walk-forward validation)
  # ==========================================================================

  # Corners betting - best strategies from pipeline (+35% ROI)
  corners:
    enabled: true
    approach: "classification"
    model_type: "stacking_xgb"  # Stacking with XGBoost meta-learner
    target: "total_corners"

    lines:
      - line: 10.5
        direction: "UNDER"
        threshold: 0.70
        expected_roi: 34.5
      - line: 9.5
        direction: "OVER"
        threshold: 0.65
        expected_roi: 32.2
      - line: 11.5
        direction: "UNDER"
        threshold: 0.75
        expected_roi: 24.5

    key_features:
      - ref_corner_avg
      - ref_corner_std
      - odds_goals_expectation
      - home_elo
      - away_elo

  # Cards betting - best strategies from pipeline (+25% ROI)
  cards:
    enabled: true
    approach: "classification"
    model_type: "xgboost"
    target: "total_cards"

    lines:
      - line: 4.5
        direction: "OVER"
        threshold: 0.70
        expected_roi: 25.4
      - line: 3.5
        direction: "OVER"
        threshold: 0.65
        expected_roi: 22.1

    key_features:
      - ref_cards_avg
      - ref_cards_std
      - home_avg_yellows
      - away_avg_yellows

  # Shots betting - best strategies from pipeline (+46% ROI)
  shots:
    enabled: true
    approach: "classification"
    model_type: "random_forest"
    target: "total_shots"

    lines:
      - line: 24.5
        direction: "UNDER"
        threshold: 0.75
        expected_roi: 46.2
      - line: 22.5
        direction: "OVER"
        threshold: 0.75
        expected_roi: 34.6
      - line: 26.5
        direction: "UNDER"
        threshold: 0.75
        expected_roi: 27.5

    key_features:
      - ref_shots_avg
      - home_shots_avg
      - away_shots_avg

  # Fouls betting - VALIDATED best strategy from weekend paper trading
  # PAPER TRADING RESULT: 81.8% hit rate (9/11) - GENUINE EDGE CONFIRMED
  # Temperature analysis showed model is UNDERCONFIDENT (T=0.45)
  fouls:
    enabled: true
    approach: "classification"
    model_type: "catboost"
    target: "total_fouls"
    calibration_factor: 1.0  # Keep as-is - model is underconfident, not overconfident

    lines:
      - line: 26.5
        direction: "OVER"
        threshold: 0.70  # Can be lower since model underconfident
        expected_roi: 52.9
      - line: 24.5
        direction: "OVER"
        threshold: 0.70
        expected_roi: 43.6
      - line: 24.5
        direction: "UNDER"
        threshold: 0.70  # UNDER also performed well (6/7 = 86%)
        expected_roi: 40.0
      - line: 22.5
        direction: "OVER"
        threshold: 0.70
        expected_roi: 39.6

    key_features:
      - ref_fouls_avg  # SHAP importance: 0.45
      - ref_fouls_std
      - home_fouls_avg
      - away_fouls_avg

# League-specific adjustments (optional)
league_adjustments:
  premier_league:
    btts_rate_adjustment: 0.02  # Slightly higher BTTS in EPL
  bundesliga:
    btts_rate_adjustment: 0.05  # Highest BTTS rate
  la_liga:
    btts_rate_adjustment: -0.03  # Lower BTTS rate

# Risk management
risk_management:
  max_daily_bets: 10
  max_stake_per_bet: 0.05  # 5% of bankroll
  stop_loss_daily: 0.10  # Stop if 10% down
  take_profit_daily: 0.20  # Lock in if 20% up

# Pilot mode settings
pilot:
  paper_trading: true  # No real money initially
  min_bets_before_live: 100  # Validate with 100 paper bets first
  performance_threshold: 0.05  # Need 5% ROI in paper trading
