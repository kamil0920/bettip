# Betting Strategies Configuration
# Updated from optimization-results-15 (2026-01-23)
# Away Win updated from Phase 4-5 optimization (2026-01-24)
# Walk-forward validated with 120 Optuna trials per market

# Global settings
settings:
  min_odds: 1.30
  max_odds: 10.0
  min_confidence: 0.8  # Minimum P(profit) to deploy
  bankroll_fraction: 0.02  # Kelly fraction for bet sizing

# Calibration settings (updated from optimization-results-15, 2026-01-23)
# All markets use Platt scaling calibration from walk-forward validation
calibration:
  enabled: true
  method: "platt"  # Changed from temperature - better per optimization
  per_market:
    OVER_2.5:
      factor: 0.5
      enabled: false  # DISABLED: -3.2% ROI, 27% P(profit)
    HOME_WIN:
      factor: 0.7
      enabled: false  # DISABLED: +2.0% ROI marginal, 59.5% P(profit)
    BTTS:
      factor: 0.90
      enabled: false  # DISABLED: +0.2% ROI break-even, no edge
      min_threshold: 0.70
    FOULS:
      factor: 1.0  # Underconfident model - keep as-is
      enabled: true  # BEST: +74.3% ROI, 100% P(profit), Sharpe 1.18
      min_threshold: 0.65
    SHOTS:
      factor: 1.0  # Use ensemble to reduce variance
      enabled: true  # +50.6% ROI, 100% P(profit), Sharpe 0.66
      min_threshold: 0.70
    CORNERS:
      factor: 0.88
      enabled: false  # DISABLED: -3.0% ROI, 36% P(profit)
      min_threshold: 0.70
    AWAY_WIN:
      factor: 1.0  # Platt calibration applied in training
      enabled: true  # +18.9% ROI, 99.9% P(profit), Sharpe 0.18
      min_threshold: 0.40
    UNDER_2.5:
      factor: 1.0
      enabled: true  # +5.0% ROI, 84% P(profit) - modest edge
      min_threshold: 0.55
    CARDS:
      factor: 1.0
      enabled: true  # +8.6% ROI, 66.5% P(profit) - monitor sample size
      min_threshold: 0.70

# Model training settings
training:
  test_size: 0.2
  val_size: 0.2
  n_optuna_trials: 100
  random_state: 42
  cv_folds: 5

# Bet type strategies
strategies:
  # Rank 1: Asian Handicap - DISABLED
  # optimization-results-15: -12.5% ROI, 45.5% precision, P(profit) = 18.3%
  # 55 bets, Sharpe = -0.129 - clearly unprofitable
  asian_handicap:
    enabled: false
    approach: "regression"
    model_type: "ensemble"
    target: "goal_margin"

    line_filter:
      min: -4.0
      max: -1.5
    bet_side: "away"
    edge_threshold: 0.3

    expected_roi: -12.5  # Updated from optimization-results-15
    p_profit: 0.18

    # Features to use (top from permutation importance)
    top_features:
      - margin_edge
      - composite_expected_margin
      - season_margin_per_game
      - away_win_prob_elo
      - poisson_away_win_prob
      - home_away_gd_diff
      - home_scoring_streak
      - away_pts_to_leader
      - h2h_away_wins
      - home_goals_conceded_ema

    # Odds columns
    odds_column: "avg_ah_away"

  # Rank 2: BTTS (Both Teams To Score)
  # DISABLED: optimization-results-15 showed +0.2% ROI (break-even, no edge)
  # 606 bets, 52.5% precision, P(profit) = 54.1%, Sharpe = -0.00
  btts:
    enabled: false  # No edge - break-even market
    approach: "classification"
    model_type: "catboost"
    target: "btts"  # Both teams score

    probability_threshold: 0.75
    calibration_factor: 0.7
    bet_side: "yes"

    expected_roi: 0.2  # Updated from optimization-results-15
    p_profit: 0.54

    top_features:
      - home_scores_prob
      - away_scores_prob
      - btts_composite
      - league_btts_rate
      - home_attack_strength
      - away_attack_strength
      - home_clean_sheet_rate
      - away_clean_sheet_rate
      - total_attack
      - min_defense

    odds_column: "btts_yes_odds"

  # Rank 3: Away Win - PRODUCTION READY (High Precision Mode)
  # Phase 4-5 Optimization (2026-01-24):
  #   - LightGBM with Optuna-tuned hyperparameters
  #   - 271 RFE-optimized features (from 371)
  #   - Threshold 0.70 achieves 69.1% precision, 107.3% ROI
  #   - 55 high-confidence bets, 38 wins
  # Previous: LogisticReg >= 0.4 gave 18.9% ROI on 212 bets
  away_win:
    enabled: true
    approach: "classification"
    model_type: "lightgbm"  # Changed from logistic_regression per Phase 4
    target: "away_win"

    probability_threshold: 0.70  # Raised from 0.40 per Phase 5 threshold optimization
    calibration_method: "platt"
    min_odds: 1.8  # Optimal from Phase 5
    max_odds: 4.0  # Optimal from Phase 5

    # LightGBM hyperparameters from Phase 4 Optuna tuning
    model_params:
      n_estimators: 200
      max_depth: 3
      learning_rate: 0.0193
      num_leaves: 91
      min_child_samples: 71
      reg_alpha: 0.00009
      reg_lambda: 0.00002

    expected_roi: 107.3  # Updated from Phase 5 optimization
    expected_precision: 0.691  # 69.1% precision
    p_profit: 0.999

    # Use 271 RFE-optimized features (loaded from rfe_20260124_112415.json)
    use_rfe_features: true
    rfe_features_file: "experiments/outputs/feature_selection/rfe_20260124_112415.json"

    # Top 10 features by SHAP importance (for reference)
    top_features:
      - poisson_away_win_prob
      - away_win_prob_elo
      - odds_away_prob
      - away_attack_strength
      - ppg_diff
      - home_goals_conceded_ema
      - position_diff
      - home_form_ema
      - away_form_ema
      - home_away_gd_diff

    odds_column: "avg_away_open"

  # Rank 4: Under 2.5 Goals - ENABLED WITH MONITORING
  # optimization-results-15: +5.0% ROI, 58.3% precision, P(profit) = 84.3%
  # 355 bets, Sharpe = 0.054 - modest but positive edge
  under25:
    enabled: true  # Re-enabled per optimization results
    approach: "classification"
    model_type: "logistic_regression"
    target: "under25"

    probability_threshold: 0.55  # Optimized threshold
    calibration_method: "platt"

    expected_roi: 5.0  # Updated from optimization-results-15
    p_profit: 0.84

    odds_column: "avg_under25"

  # Rank 5: Over 2.5 Goals - DISABLED
  # optimization-results-15: -3.2% ROI, 62.2% precision, P(profit) = 27.3%
  # 222 bets, Sharpe = -0.041 - negative edge despite decent precision
  over25:
    enabled: false
    approach: "classification"
    model_type: "lightgbm"
    target: "over25"

    probability_threshold: 0.85
    calibration_factor: 0.5

    expected_roi: -3.2  # Updated from optimization-results-15
    p_profit: 0.27

    odds_column: "avg_over25"

  # Rank 6: Home Win - DISABLED
  # optimization-results-15: +2.0% ROI, 66.3% precision, P(profit) = 59.5%
  # 92 bets, Sharpe = 0.017 - marginal edge not worth the risk
  home_win:
    enabled: false
    approach: "classification"
    model_type: "xgboost"
    target: "home_win"

    probability_threshold: 0.55

    expected_roi: 2.0  # Updated from optimization-results-15
    p_profit: 0.60

    odds_column: "avg_home_open"

  # ==========================================================================
  # NICHE MARKETS (High ROI from walk-forward validation)
  # ==========================================================================

  # Corners betting - DISABLED
  # optimization-results-15: -3.0% ROI, 57.5% precision, P(profit) = 36%
  # 120 bets, Sharpe = -0.036 - no edge despite decent precision
  corners:
    enabled: false  # Negative ROI from walk-forward validation
    approach: "classification"
    model_type: "stacking_xgb"
    target: "total_corners"

    lines:
      - line: 10.5
        direction: "UNDER"
        threshold: 0.70
        expected_roi: -3.0  # Updated
      - line: 9.5
        direction: "OVER"
        threshold: 0.65
        expected_roi: -3.0
      - line: 11.5
        direction: "UNDER"
        threshold: 0.75
        expected_roi: -3.0

    key_features:
      - ref_corner_avg
      - ref_corner_std
      - odds_goals_expectation
      - home_elo
      - away_elo

  # Cards betting (Over 4.5) - ENABLED WITH MONITORING
  # optimization-results-15: +8.6% ROI, 46.2% precision, P(profit) = 66.5%
  # 39 bets - small sample, monitor closely
  cards:
    enabled: true  # Keep enabled but monitor sample size
    approach: "classification"
    model_type: "xgboost"
    target: "total_cards"

    lines:
      - line: 4.5
        direction: "OVER"
        threshold: 0.70
        expected_roi: 8.6  # Updated from optimization-results-15

    key_features:
      - expected_home_cards
      - home_cards_ema
      - away_cards_ema
      - expected_total_cards
      - ref_draw_pct
      - away_fouls_drawn_ema
      - expected_total_fouls
      - away_avg_yellows

  # Shots betting (Over 24.5) - TOP PERFORMER #2
  # optimization-results-15: +50.6% ROI, 79.2% precision, P(profit) = 100%
  # Walk-forward: +25.0% avg ROI (±11.8%), Sharpe = 0.66
  # Best strategy: Average >= 0.7 (53 bets - ensemble approach)
  # WARNING: LightGBM had -36.7% in fold 2 (6 bets) - use ensemble to reduce variance
  shots:
    enabled: true
    approach: "classification"
    model_type: "ensemble_average"  # Use model averaging for stability
    target: "total_shots"

    lines:
      - line: 24.5
        direction: "OVER"
        threshold: 0.70  # Optimized threshold
        expected_roi: 50.6  # Updated from optimization-results-15

    calibration_method: "platt"

    key_features:
      - expected_total_shots
      - expected_total_corners
      - combined_shots_ema
      - home_corners_won_ema
      - away_shot_accuracy
      - expected_away_shots
      - home_shots_ema_x
      - away_shots_conceded_ema
      - ppg_diff
      - position_diff

  # Fouls betting (Over 24.5) - TOP PERFORMER #1
  # optimization-results-15: +74.3% ROI, 88.5% precision, P(profit) = 100%
  # Walk-forward: +31.6% avg ROI (±11.4%), Sharpe = 1.18 (EXCELLENT)
  # Best strategy: LogisticReg >= 0.65 (52 bets)
  # All folds positive: +15% to +48% per model - highly consistent
  fouls:
    enabled: true
    approach: "classification"
    model_type: "logistic_regression"  # Changed per optimization results
    target: "total_fouls"
    calibration_method: "platt"
    calibration_factor: 1.0  # Model underconfident - keep probabilities as-is

    lines:
      - line: 24.5
        direction: "OVER"
        threshold: 0.65  # Optimized threshold from walk-forward
        expected_roi: 74.3  # Updated from optimization-results-15

    key_features:
      - expected_total_fouls
      - expected_home_fouls
      - expected_away_fouls
      - expected_total_cards
      - home_cards_ema
      - away_fouls_drawn_ema
      - home_fouls_drawn_ema
      - discipline_diff
      - h2h_avg_goals
      - poisson_draw_prob

# League-specific adjustments (optional)
league_adjustments:
  premier_league:
    btts_rate_adjustment: 0.02  # Slightly higher BTTS in EPL
  bundesliga:
    btts_rate_adjustment: 0.05  # Highest BTTS rate
  la_liga:
    btts_rate_adjustment: -0.03  # Lower BTTS rate

# Risk management
risk_management:
  max_daily_bets: 10
  max_stake_per_bet: 0.05  # 5% of bankroll
  stop_loss_daily: 0.10  # Stop if 10% down
  take_profit_daily: 0.20  # Lock in if 20% up

# Pilot mode settings
pilot:
  paper_trading: true  # No real money initially
  min_bets_before_live: 100  # Validate with 100 paper bets first
  performance_threshold: 0.05  # Need 5% ROI in paper trading
